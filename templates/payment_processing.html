{% extends "base.html" %}

{% block title %}Payment Processing - Lipia Subscription Service{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h4 class="card-title mb-0">Payment Processing</h4>
            </div>
            <div class="card-body text-center">
                <div class="py-4">
                    <div class="mb-4">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    
                    <h5 class="mb-3">Payment in Progress</h5>
                    <p>An M-PESA payment request has been sent to your phone ({{ phone_number }}).</p>
                    <p>Please check your phone and approve the payment of ${{ amount }}.</p>
                    <p id="status-message">Waiting for payment...</p>
                    
                    <div class="alert alert-info">
                        <p class="mb-0"><strong>Transaction ID:</strong> {{ checkout_id }}</p>
                    </div>
                    
                    <div class="d-grid mt-4">
                        <a href="{{ url_for('cancel_payment', checkout_id=checkout_id) }}" class="btn btn-danger">Cancel Payment</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Function to check payment status
    function checkPaymentStatus() {
        fetch('{{ url_for("check_payment_status", checkout_id=checkout_id) }}')
            .then(response => response.json())
            .then(data => {
                // Update status message
                document.getElementById('status-message').textContent = data.message;
                
                // If payment is completed or failed, redirect
                if (data.status === 'completed') {
                    window.location.href = '{{ url_for("payment_success", checkout_id=checkout_id) }}';
                } else if (data.status === 'failed' || data.status === 'cancelled') {
                    window.location.href = '{{ url_for("payment_failed", checkout_id=checkout_id) }}';
                } else {
                    // Check again in 3 seconds
                    setTimeout(checkPaymentStatus, 3000);
                }
            })
            .catch(error => {
                console.error('Error checking payment status:', error);
                // Check again in 5 seconds (longer interval on error)
                setTimeout(checkPaymentStatus, 5000);
            });
    }
    
    // Start checking payment status when page loads
    document.addEventListener('DOMContentLoaded', function() {
        checkPaymentStatus();
        
        // Set timeout for payment (2 minutes)
        setTimeout(function() {
            window.location.href = '{{ url_for("payment_timeout", checkout_id=checkout_id) }}';
        }, 120000);
    });
</script>
{% endblock %}
